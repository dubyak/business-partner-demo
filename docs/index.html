<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Business Partner - Multi-Agent AI Demo</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            max-width: 800px;
            margin: 0 auto;
            width: 100%;
            background: white;
            box-shadow: 0 0 20px rgba(0,0,0,0.1);
        }

        .chat-header {
            background: #4A90A4;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: 18px;
            font-weight: 500;
            position: relative;
        }

        .chat-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
            margin-top: 4px;
        }

        .api-status {
            position: absolute;
            top: 20px;
            right: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ccc;
        }

        .api-status.connected {
            background: #4ade80;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            background: #f5f5f5;
        }

        .message {
            display: flex;
            margin-bottom: 20px;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .message.assistant {
            justify-content: flex-start;
        }

        .message.user {
            justify-content: flex-end;
        }

        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: #4A90A4;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            flex-shrink: 0;
        }

        .message.assistant .message-avatar {
            margin-right: 12px;
        }

        .message.user .message-avatar {
            margin-left: 12px;
            order: 2;
            background: #d0d0d0;
        }

        .message-content {
            max-width: 70%;
            padding: 12px 16px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 15px;
        }

        .message.assistant .message-content {
            background: #D4EAEF;
            color: #1a1a1a;
            border-bottom-left-radius: 4px;
        }

        .message.user .message-content {
            background: #E8E8E8;
            color: #1a1a1a;
            border-bottom-right-radius: 4px;
        }

        .message-content img {
            max-width: 100%;
            border-radius: 8px;
            margin-top: 8px;
            display: block;
        }

        .input-container {
            padding: 16px;
            background: white;
            border-top: 1px solid #e0e0e0;
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .attachment-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 24px;
            color: #666;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        #messageInput {
            width: 100%;
            padding: 12px 16px;
            border: none;
            background: #f5f5f5;
            border-radius: 24px;
            font-size: 15px;
            outline: none;
            font-family: inherit;
        }

        #messageInput::placeholder {
            color: #999;
        }

        .send-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: #4A90A4;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 18px;
            transition: background 0.2s;
        }

        .send-btn:hover:not(:disabled) {
            background: #3a7a8a;
        }

        .send-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .typing-indicator {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 12px 16px;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #4A90A4;
            animation: typing 1.4s infinite;
        }

        .typing-indicator span:nth-child(2) {
            animation-delay: 0.2s;
        }

        .typing-indicator span:nth-child(3) {
            animation-delay: 0.4s;
        }

        @keyframes typing {
            0%, 60%, 100% {
                transform: translateY(0);
                opacity: 0.7;
            }
            30% {
                transform: translateY(-10px);
                opacity: 1;
            }
        }

        #fileInput {
            display: none;
        }

        .image-preview {
            display: inline-block;
            margin-top: 8px;
            max-width: 200px;
            border-radius: 8px;
            overflow: hidden;
        }

        .image-preview img {
            width: 100%;
            display: block;
        }

        .config-panel {
            background: #fffbeb;
            border: 1px solid #fbbf24;
            padding: 12px;
            margin: 12px;
            border-radius: 8px;
            font-size: 13px;
        }

        .config-panel input {
            width: 100%;
            padding: 8px;
            margin-top: 8px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 13px;
        }

        .config-panel button {
            margin-top: 8px;
            padding: 8px 16px;
            background: #4A90A4;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .config-panel button:hover {
            background: #3a7a8a;
        }
    </style>
</head>
<body>
    <div class="chat-container">
        <div class="chat-header">
            <div class="api-status" id="apiStatus"></div>
            Business Partner - Multi-Agent AI
            <div class="subtitle">Powered by LangGraph + Langfuse</div>
        </div>

        <div class="config-panel" id="configPanel">
            <strong>⚙️ Configure Backend URL</strong>
            <input type="text" id="apiUrlInput" placeholder="Enter your Python backend URL (e.g., https://your-backend.com)" />
            <button onclick="saveApiUrl()">Save & Connect</button>
            <div style="margin-top: 8px; color: #666;">
                Or use: <code style="background:#fff;padding:2px 6px;border-radius:3px;">http://localhost:8000</code> for local testing
            </div>
        </div>

        <div class="messages-container" id="messagesContainer">
            <!-- Messages will be added here -->
        </div>

        <div class="input-container">
            <button class="attachment-btn" id="attachBtn" title="Attach image">
                <span>+</span>
            </button>
            <input type="file" id="fileInput" accept="image/*" multiple />
            <div class="input-wrapper">
                <input type="text" id="messageInput" placeholder="Type a message..." />
            </div>
            <button class="send-btn" id="sendBtn">
                <span>▶</span>
            </button>
        </div>
    </div>

    <script>
        // Configuration
        const API_URL_KEY = 'business-partner-api-url';
        const SESSION_ID_KEY = 'business-partner-session-id';

        function getApiUrl() {
            return localStorage.getItem(API_URL_KEY) || '';
        }

        function saveApiUrl() {
            const url = document.getElementById('apiUrlInput').value.trim();
            if (url) {
                // Remove trailing slash if present
                const cleanUrl = url.replace(/\/$/, '');
                localStorage.setItem(API_URL_KEY, cleanUrl);
                document.getElementById('configPanel').style.display = 'none';
                checkApiConnection();
                initializeChat();
            }
        }

        function getSessionId() {
            let sessionId = localStorage.getItem(SESSION_ID_KEY);
            if (!sessionId) {
                sessionId = `session-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                localStorage.setItem(SESSION_ID_KEY, sessionId);
            }
            return sessionId;
        }

        const SESSION_ID = getSessionId();
        console.log('Session ID:', SESSION_ID);

        // State
        let conversationHistory = [];
        let pendingImages = [];

        // DOM elements
        const messagesContainer = document.getElementById('messagesContainer');
        const messageInput = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const attachBtn = document.getElementById('attachBtn');
        const fileInput = document.getElementById('fileInput');
        const apiStatus = document.getElementById('apiStatus');
        const configPanel = document.getElementById('configPanel');
        const apiUrlInput = document.getElementById('apiUrlInput');

        // Initialize
        async function init() {
            const savedUrl = getApiUrl();
            if (savedUrl) {
                apiUrlInput.value = savedUrl;
                configPanel.style.display = 'none';
                await checkApiConnection();
                initializeChat();
            } else {
                // Show config panel
                configPanel.style.display = 'block';
            }
        }

        async function checkApiConnection() {
            const apiUrl = getApiUrl();
            if (!apiUrl) return;

            try {
                const response = await fetch(`${apiUrl}/health`, { timeout: 5000 });
                if (response.ok) {
                    apiStatus.classList.add('connected');
                    return true;
                }
            } catch (error) {
                console.error('API connection failed:', error);
            }
            apiStatus.classList.remove('connected');
            return false;
        }

        function initializeChat() {
            const welcomeMessage = "Hello! Welcome to your new business growth journey. I'm so glad to connect with you today.\n\nYou've been such a valued customer—successfully completing three loan cycles—and we're excited to offer you something new: larger loans with longer terms to help your business grow even more.\n\nTo get started, we'll have an onboarding conversation where I'll learn about your business and show you how I can support you. You'll share some photos and business records. After we complete onboarding, you'll receive a formal loan offer. And if you accept, I'll be here to help you increase sales, manage cash flow better, and make your business more profitable.\n\nAre you ready to tell me about your business? What type of business do you run and where are you located?\n\nTuka Pamoja";

            addMessage('assistant', welcomeMessage);
            conversationHistory.push({
                role: "assistant",
                content: welcomeMessage
            });
        }

        // Event listeners
        attachBtn.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            files.forEach(file => {
                const reader = new FileReader();
                reader.onload = (event) => {
                    pendingImages.push(event.target.result);
                    showImagePreview(event.target.result);
                };
                reader.readAsDataURL(file);
            });
            fileInput.value = '';
        });

        sendBtn.addEventListener('click', sendMessage);
        messageInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        function showImagePreview(imageData) {
            const previewDiv = document.createElement('div');
            previewDiv.className = 'image-preview';
            previewDiv.innerHTML = `<img src="${imageData}" alt="Preview">`;
            messageInput.parentElement.insertBefore(previewDiv, messageInput);
        }

        function clearImagePreviews() {
            const previews = document.querySelectorAll('.image-preview');
            previews.forEach(p => p.remove());
        }

        async function sendMessage() {
            const text = messageInput.value.trim();
            const images = [...pendingImages];

            if (!text && images.length === 0) return;

            const apiUrl = getApiUrl();
            if (!apiUrl) {
                alert('Please configure your backend URL first');
                configPanel.style.display = 'block';
                return;
            }

            // Disable input
            sendBtn.disabled = true;
            messageInput.disabled = true;

            // Clear input
            messageInput.value = '';
            pendingImages = [];
            clearImagePreviews();

            // Add user message
            addMessage('user', text, images);

            // Build message content for API
            let messageContent = [];

            if (images.length > 0) {
                images.forEach(img => {
                    messageContent.push({
                        type: "image",
                        source: {
                            type: "base64",
                            media_type: "image/jpeg",
                            data: img.split(',')[1]
                        }
                    });
                });
            }

            if (text) {
                messageContent.push({
                    type: "text",
                    text: text
                });
            }

            // Add to conversation history
            conversationHistory.push({
                role: "user",
                content: messageContent.length === 1 && messageContent[0].type === "text"
                    ? text
                    : messageContent
            });

            // Show typing indicator
            showTypingIndicator();

            // Get AI response
            try {
                const response = await getAIResponse();
                hideTypingIndicator();
                addMessage('assistant', response);
                conversationHistory.push({
                    role: "assistant",
                    content: response
                });
            } catch (error) {
                hideTypingIndicator();
                addMessage('assistant', '❌ Error connecting to backend. Please check your API URL configuration.');
                console.error('Error:', error);
            }

            // Re-enable input
            sendBtn.disabled = false;
            messageInput.disabled = false;
            messageInput.focus();
        }

        function addMessage(sender, text, images = []) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = sender === 'assistant' ? '🤖' : 'U';

            const content = document.createElement('div');
            content.className = 'message-content';

            if (text) {
                const formattedText = text
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');
                content.innerHTML = formattedText;
            }

            if (images && images.length > 0) {
                images.forEach(imgData => {
                    const img = document.createElement('img');
                    img.src = imgData;
                    content.appendChild(img);
                });
            }

            if (sender === 'assistant') {
                messageDiv.appendChild(avatar);
                messageDiv.appendChild(content);
            } else {
                messageDiv.appendChild(content);
                messageDiv.appendChild(avatar);
            }

            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'message assistant';
            indicator.id = 'typingIndicator';

            const avatar = document.createElement('div');
            avatar.className = 'message-avatar';
            avatar.textContent = '🤖';

            const content = document.createElement('div');
            content.className = 'message-content';
            content.innerHTML = '<div class="typing-indicator"><span></span><span></span><span></span></div>';

            indicator.appendChild(avatar);
            indicator.appendChild(content);
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function hideTypingIndicator() {
            const indicator = document.getElementById('typingIndicator');
            if (indicator) {
                indicator.remove();
            }
        }

        async function getAIResponse() {
            const apiUrl = getApiUrl();
            const response = await fetch(`${apiUrl}/api/chat`, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    messages: conversationHistory,
                    session_id: SESSION_ID,
                    user_id: 'demo-user'
                })
            });

            if (!response.ok) {
                throw new Error(`API request failed: ${response.status}`);
            }

            const data = await response.json();
            return data.content[0].text;
        }

        // Check connection periodically
        setInterval(checkApiConnection, 30000);

        // Initialize on load
        init();
    </script>
</body>
</html>
